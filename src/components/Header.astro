---
import logoSvg from "../assets/logos/logo.svg";

interface NavChild {
  label: string;
  href: string;
}

interface NavLink {
  label: string;
  href: string;
  children?: NavChild[];
}

const navLinks: NavLink[] = [
  { label: "Home", href: "/" },
  { label: "About", href: "/about/" },
  { label: "Shop", href: "/products/" },
  { label: "Wholesale", href: "/wholesale/" },
  { label: "Batana", href: "/batana-oil/" },
  { label: "Honey", href: "/stingless-bee-honey/" },
  { label: "Herbs", href: "/traditional-herbs/" },
  {
    label: "Community",
    href: "/community/",
    children: [
      { label: "Blog", href: "/community/blog/" },
      { label: "FAQs", href: "/community/faqs/" },
      { label: "Testimonials", href: "/community/testimonials/" },
      { label: "Docs", href: "/community/docs/" },
    ],
  },
  { label: "Contact", href: "/contact/" },
];

const currentPath = Astro.url.pathname;

// Flatten nav links for mobile menu — community children are inlined below parent
interface MobileItem {
  label: string;
  href: string;
  topIndex: number | null;
  isChild: boolean;
  isParentWithChildren: boolean;
}

const mobileItems: MobileItem[] = [];
let topIndex = 0;
for (const link of navLinks) {
  mobileItems.push({
    label: link.label,
    href: link.href,
    topIndex: ++topIndex,
    isChild: false,
    isParentWithChildren: !!link.children,
  });
  if (link.children) {
    for (const child of link.children) {
      mobileItems.push({
        label: child.label,
        href: child.href,
        topIndex: null,
        isChild: true,
        isParentWithChildren: false,
      });
    }
  }
}
---

<header
  id="site-header"
  class="sticky top-0 z-50 border-b border-mint bg-white/95 backdrop-blur-sm transition-colors duration-300"
>
  <nav class="mx-auto flex max-w-7xl items-center justify-between px-4 py-3 lg:px-8">
    <!-- Logo -->
    <a href="/" class="flex shrink-0 items-center gap-2">
      <img src={logoSvg.src} alt="" aria-hidden="true" width="40" height="40" class="h-10 w-10" />
      <span
        id="logo-label"
        class="hidden font-[family-name:var(--font-heading)] text-lg font-semibold text-leaf-green transition-colors duration-300 sm:inline"
      >
        Forestal MT
      </span>
    </a>

    <!-- Desktop nav -->
    <ul class="hidden items-center gap-5 font-[family-name:var(--font-ui)] text-[13px] lg:flex">
      {
        navLinks.map((link) => (
          <li class:list={[link.children ? "group relative" : ""]}>
            <a
              href={link.href}
              class:list={[
                "flex items-center gap-1 transition-colors hover:text-leaf-green",
                (link.children ? currentPath.startsWith(link.href) : currentPath === link.href)
                  ? "font-semibold text-leaf-green"
                  : "text-graphite",
              ]}
            >
              {link.label}
              {link.children && (
                <svg
                  class="h-2.5 w-2.5 transition-transform duration-200 group-hover:rotate-180"
                  viewBox="0 0 10 10"
                  fill="currentColor"
                  aria-hidden="true"
                >
                  <path d="M5 6.5L0.5 2h9L5 6.5z" />
                </svg>
              )}
            </a>

            {link.children && (
              <ul class="pointer-events-none invisible absolute left-0 top-full z-50 w-48 overflow-hidden rounded-md border border-gray-100 bg-white py-1 opacity-0 shadow-xl transition-all duration-200 before:absolute before:-top-2 before:left-0 before:h-2 before:w-full group-hover:pointer-events-auto group-hover:visible group-hover:opacity-100">
                {link.children.map((child) => (
                  <li>
                    <a
                      href={child.href}
                      class:list={[
                        "block px-4 py-2.5 text-[12px] transition-colors hover:bg-parchment hover:text-leaf-green",
                        currentPath === child.href
                          ? "font-semibold text-leaf-green"
                          : "text-graphite",
                      ]}
                    >
                      {child.label}
                    </a>
                  </li>
                ))}
              </ul>
            )}
          </li>
        ))
      }
    </ul>

    <!-- Hamburger button -->
    <button
      id="mobile-menu-btn"
      type="button"
      class="relative z-50 flex h-10 w-10 flex-col items-center justify-center gap-[5px] text-graphite transition-colors duration-300 lg:hidden"
      aria-label="Toggle menu"
      aria-expanded="false"
    >
      <span class="bar block h-[1.5px] w-5 origin-center bg-current transition-all duration-300"
      ></span>
      <span class="bar block h-[1.5px] w-5 bg-current transition-all duration-300"></span>
      <span class="bar block h-[1.5px] w-5 origin-center bg-current transition-all duration-300"
      ></span>
    </button>
  </nav>
</header>

<!-- Full-screen mobile overlay (z-40 — behind header z-50) -->
<div
  id="mobile-menu"
  role="dialog"
  aria-modal="true"
  aria-label="Site navigation"
  aria-hidden="true"
  class="grain fixed inset-0 z-40 bg-charcoal lg:hidden"
  style="visibility: hidden; opacity: 0; transition: opacity 0.3s ease, visibility 0s linear 0.3s;"
>
  <div class="relative z-10 flex h-full flex-col justify-center px-8 pb-10 pt-16 sm:px-14">
    <nav>
      <ul>
        {
          mobileItems.map((item) => (
            <li class="mobile-nav-item border-b border-white/[0.07]">
              <a
                href={item.href}
                class:list={[
                  "group flex items-center transition-colors duration-200",
                  item.isChild ? "gap-3 py-2 pl-10" : "gap-5 py-[0.85rem]",
                  (
                    item.isParentWithChildren
                      ? currentPath.startsWith(item.href)
                      : currentPath === item.href
                  )
                    ? "text-[#F3C00D]"
                    : item.isChild
                      ? "text-white/55 hover:text-white"
                      : "text-white/50 hover:text-white",
                ]}
              >
                {!item.isChild && (
                  <span class="w-5 shrink-0 text-right font-[family-name:var(--font-ui)] text-[9px] uppercase tracking-[0.25em] text-white/20">
                    {String(item.topIndex!).padStart(2, "0")}
                  </span>
                )}
                <span
                  class:list={[
                    item.isChild
                      ? "font-[family-name:var(--font-ui)] text-[0.85rem] tracking-wider"
                      : "font-[family-name:var(--font-heading)] text-[1.6rem] font-normal leading-none tracking-wide",
                  ]}
                >
                  {item.label}
                </span>
              </a>
            </li>
          ))
        }
      </ul>
    </nav>
    <p
      class="mt-8 font-[family-name:var(--font-ui)] text-[9px] uppercase tracking-[0.25em] text-white/20"
    >
      Forestal Murillo Tejada · Honduras
    </p>
  </div>
</div>

<style is:global>
  /* Hamburger bars → X */
  .bar-top {
    transform: translateY(6.5px) rotate(45deg) !important;
    background-color: white !important;
  }
  .bar-mid {
    opacity: 0 !important;
    transform: scaleX(0) !important;
  }
  .bar-bot {
    transform: translateY(-6.5px) rotate(-45deg) !important;
    background-color: white !important;
  }

  /* Header dark state when menu is open */
  #site-header.menu-open {
    background-color: #1a1a1a !important;
    border-color: rgba(243, 192, 13, 0.1) !important;
  }
  #site-header.menu-open #logo-label {
    color: white !important;
  }
  #site-header.menu-open #mobile-menu-btn {
    color: white !important;
  }

  /* Mobile nav item stagger entrance */
  .mobile-nav-item {
    opacity: 0;
    transform: translateY(10px);
  }
  .mobile-nav-item.item-visible {
    opacity: 1;
    transform: translateY(0);
    transition:
      opacity 0.35s ease,
      transform 0.35s ease;
  }
</style>

<script>
  document.addEventListener("astro:page-load", () => {
    const btn = document.getElementById("mobile-menu-btn") as HTMLButtonElement | null;
    const menu = document.getElementById("mobile-menu") as HTMLElement | null;
    const header = document.getElementById("site-header") as HTMLElement | null;
    if (!btn || !menu || !header) return;

    const items = menu.querySelectorAll<HTMLElement>(".mobile-nav-item");
    let isOpen = false;

    // Use AbortController to clean up all listeners before the next navigation
    const ac = new AbortController();
    const { signal } = ac;
    document.addEventListener("astro:before-swap", () => ac.abort(), { once: true });

    function openMenu() {
      isOpen = true;

      menu!.style.transition = "opacity 0.3s ease, visibility 0s linear";
      menu!.style.visibility = "visible";
      menu!.style.opacity = "1";
      menu!.setAttribute("aria-hidden", "false");
      btn!.setAttribute("aria-expanded", "true");

      header!.classList.add("menu-open");

      const bars = btn!.querySelectorAll(".bar");
      bars[0].classList.add("bar-top");
      bars[1].classList.add("bar-mid");
      bars[2].classList.add("bar-bot");

      document.body.style.overflow = "hidden";

      items.forEach((item, i) => {
        item.classList.remove("item-visible");
        item.style.transitionDelay = "0ms";
        setTimeout(() => {
          item.style.transitionDelay = `${i * 40}ms`;
          item.classList.add("item-visible");
        }, 60);
      });
    }

    function closeMenu() {
      isOpen = false;

      menu!.style.transition = "opacity 0.25s ease, visibility 0s linear 0.25s";
      menu!.style.opacity = "0";
      menu!.style.visibility = "hidden";
      menu!.setAttribute("aria-hidden", "true");
      btn!.setAttribute("aria-expanded", "false");

      header!.classList.remove("menu-open");

      const bars = btn!.querySelectorAll(".bar");
      bars[0].classList.remove("bar-top");
      bars[1].classList.remove("bar-mid");
      bars[2].classList.remove("bar-bot");

      document.body.style.overflow = "";

      items.forEach((item) => {
        item.classList.remove("item-visible");
        item.style.transitionDelay = "0ms";
      });
    }

    btn.addEventListener("click", () => (isOpen ? closeMenu() : openMenu()), { signal });

    menu.querySelectorAll("a").forEach((a) => a.addEventListener("click", closeMenu, { signal }));

    document.addEventListener(
      "keydown",
      (e) => {
        if (e.key === "Escape" && isOpen) closeMenu();
      },
      { signal },
    );
  });
</script>
