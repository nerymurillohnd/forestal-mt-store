---
/**
 * SHOP PAGE — All Products
 *
 * SSG shell. Builds ShopProduct[] from 7 JSON files at build time, passes to
 * ShopFilterIsland (client:load) for client-side filter + grid rendering.
 * JSON-LD CollectionPage + ItemList generated server-side.
 */
import BaseLayout from "../../layouts/BaseLayout.astro";
import Head from "../../components/Head.astro";
import Hero from "../../components/Hero.astro";
import Breadcrumb from "../../components/Breadcrumb.astro";
import ShopFilterIsland from "../../components/islands/ShopFilterIsland";
import type { ShopProduct } from "../../components/islands/ShopFilterIsland";
import { buildShopPageGraph } from "../../lib/product-jsonld";

import productsFile from "../../data/jsonld/products/products.json";
import pricingFile from "../../data/jsonld/products/pricing.json";
import inventoryFile from "../../data/jsonld/products/inventory.json";
import contentFile from "../../data/jsonld/products/content.json";
import mediaFile from "../../data/jsonld/products/media.json";
import seoFile from "../../data/jsonld/products/seo.json";
import wholesaleFile from "../../data/jsonld/products/wholesale.json";

// ─── Catalog slug map ────────────────────────────────────────────────────────
const catalogs = [
  { name: "Batana Oil", slug: "batana-oil" },
  { name: "Stingless Bee Honey", slug: "stingless-bee-honey" },
  { name: "Traditional Herbs", slug: "traditional-herbs" },
];

// ─── Build lookup maps ───────────────────────────────────────────────────────
const pricingMap = new Map(
  pricingFile.products.map((p) => [p.ProductGroup.handler, p.ProductGroup]),
);
const inventoryMap = new Map(inventoryFile.products.map((p) => [p.handler, p]));
const contentMap = new Map(contentFile.products.map((p) => [p.handler, p]));
const mediaMap = new Map(mediaFile.products.map((p) => [p.handler, p]));
const wholesaleMap = new Map(wholesaleFile.products.map((p) => [p.handler, p]));

// ─── Published filter ────────────────────────────────────────────────────────
const publishedHandlers = new Set(
  seoFile.products.filter((s) => s.published === true).map((s) => s.handler),
);

// ─── Build ShopProduct[] ─────────────────────────────────────────────────────
const shopProducts: ShopProduct[] = productsFile.products
  .filter((p) => publishedHandlers.has(p.handler))
  .map((p) => {
    const pricing = pricingMap.get(p.handler);
    const prices = pricing?.variants.map((v) => v.price) ?? [0];
    const inv = inventoryMap.get(p.handler);
    const cont = contentMap.get(p.handler);
    const med = mediaMap.get(p.handler);
    return {
      handler: p.handler,
      productGroupId: p.productGroupId,
      name: p.name,
      catalog: p.catalog,
      catalogSlug: catalogs.find((c) => c.name === p.catalog)?.slug ?? "",
      minPrice: Math.min(...prices),
      maxPrice: Math.max(...prices),
      qualityBadge: cont?.qualityBadge ?? "",
      availability: (inv?.availability ?? "InStock") as "InStock" | "OutOfStock",
      imageUrl: med?.image.url ?? "",
      imageAlt: med?.image.alt ?? p.name,
      variantCount: p.variant_count,
      wholesaleAvailable: wholesaleMap.get(p.handler)?.wholesaleAvailable ?? false,
    };
  })
  .sort((a, b) => a.productGroupId.localeCompare(b.productGroupId));

const globalMinPrice = Math.min(...shopProducts.map((p) => p.minPrice));
const globalMaxPrice = Math.max(...shopProducts.map((p) => p.maxPrice));

// ─── JSON-LD ─────────────────────────────────────────────────────────────────
const allProductsForGraph = shopProducts.map((p) => ({
  handler: p.handler,
  name: p.name,
  imageUrl: p.imageUrl,
}));
const jsonLdString = buildShopPageGraph(allProductsForGraph);

// ─── SEO ─────────────────────────────────────────────────────────────────────
const canonicalUrl = `${import.meta.env.SITE_URL}/products/`;
const seoTitle = "Shop Batana Oil, Honey & Herbs - All Products";
const seoDescription =
  "Explore our full collection of authentic ethnobotanicals, including Batana oil, stingless bee honey, and traditional herbs sourced directly from origin.";
const ogImageUrl = "https://cdn.forestal-mt.com/pages/products/og.jpg";
---

<BaseLayout>
  <Head
    slot="head"
    title={seoTitle}
    description={seoDescription}
    canonicalUrl={canonicalUrl}
    pageName="Authentic Ethnobotanical Treasures"
    og={{
      title: seoTitle,
      description: seoDescription,
      image: {
        url: ogImageUrl,
        alt: "Forestal MT — Premium Ethnobotanical Products from Honduras",
        width: 1200,
        height: 630,
      },
    }}
    twitter={{ card: "summary_large_image" }}
    schemas={[]}
  />
  <script is:inline slot="head" type="application/ld+json" set:html={jsonLdString} />

  <Breadcrumb pageName="Authentic Ethnobotanical Treasures" />

  <Hero
    background={{
      type: "image",
      url: "https://cdn.forestal-mt.com/pages/products/hero.jpg",
      alt: "Forestal MT premium ethnobotanical products collection",
      width: 1920,
      height: 1080,
    }}
    eyebrow="FROM FOREST TO CUSTOMER"
    title="Authentic Ethnobotanical Treasures"
    subtitle="Forestal MT Product Catalogue"
    description="Explore our full collection of authentic ethnobotanicals, including Batana oil, stingless bee honey, and traditional herbs sourced directly from origin."
  />

  <section class="surface-warm">
    <div class="mx-auto max-w-7xl px-4 py-12 lg:px-8">
      <ShopFilterIsland
        client:load
        products={shopProducts}
        globalMinPrice={globalMinPrice}
        globalMaxPrice={globalMaxPrice}
      />
    </div>
  </section>
</BaseLayout>
